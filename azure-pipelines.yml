# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java
parameters:
  - name: MATH_DOJO_ENV_NAME
    default: "MATH_DOJO_ENV_NAME"
    type: string
  - name: MATH_DOJO_HTTP_REQUEST_SIGNATURE_EXPECTED_KEYID
    default: "MATH_DOJO_HTTP_REQUEST_SIGNATURE_EXPECTED_KEYID"
    type: string
  - name: MATH_DOJO_HTTP_REQUEST_SIGNATURE_B64_DER_PUBLIC_KEY
    default: "MATH_DOJO_HTTP_REQUEST_SIGNATURE_B64_DER_PUBLIC_KEY"
    type: string
  - name: SPRING_DATA_MONGODB_DATABASE
    default: "SPRING_DATA_MONGODB_DATABASE"
    type: string
trigger:
- master
- develop
#- ft*
variables:
  - ${{ if eq(variables['Build.SourceBranchName'], 'master') }}: # only works if you have a master branch
      - template: environments/pre-production.yml
      - group: 'secrets.pre-production'
  - ${{ if eq(variables['Build.SourceBranchName'], 'develop') }}: # only works if you have a develop branch
      - template: environments/non-production.yml
      - group: 'secrets.non-production'
  - ${{ if contains(variables['Build.SourceBranchName'], 'ft') }}: # only works if you have a feature branch
      - template: environments/non-production.yml
      - group: 'secrets.non-production'
  - ${{ if contains(variables['Build.SourceBranchName'], 'merge') }}: # only works if you have a PR branch
      - template: environments/non-production.yml
      - group: 'secrets.non-production'
  - ${{ if contains(variables['Build.SourceBranchName'], 'rl') }}: # only works if you have a release branch
      - template: environments/production.yml
      - group: 'secrets.production'

pool:
  vmImage: 'windows-2019'
stages:
  - stage: Build
    variables:
      ${{ if eq(variables['Build.Reason'], 'PullRequest') }}: 
        functionAppName: "pr$(System.PullRequest.PullRequestNumber)"
      ${{ if not(eq(variables['Build.Reason'], 'PullRequest')) }}: 
        functionAppName: "$(Build.SourceBranchName)"
    jobs:
      - job: Build_and_Exec_Unit_Tests
        variables:
          - template: environments/local.yml
        steps:
          - script: |
              mvnw -DfunctionAppName=question-service-$(Build.SourceBranchName) clean package
            displayName: Build package
          - script: |
              cd ./integration-tests
              npm run pretest && npm run local:test:windows
              displayName: Run Local Integration Tests
          
          - task: AzureCLI@2
            displayName: 'Deploy app'
            inputs:
              addSpnToEnvironment: true
              failOnStandardError: true
              azureSubscription: question-service-hzprod-rg-access
              scriptType: ps
              scriptLocation: inlineScript
              inlineScript: |
                  $xmlcontent = ("<settings xmlns=`"http://maven.apache.org/SETTINGS/1.0.0`" xmlns:xsi=`"http://www.w3.org/2001/XMLSchema-instance`" xsi:schemaLocation=`"http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd`"><servers><server><id>azure-auth</id><configuration><client>$env:servicePrincipalId</client><tenant>$env:tenantId</tenant><key>$env:servicePrincipalKey</key><environment>AZURE</environment></configuration></server></servers></settings>")
                  $xmlcontent
                  New-Item -Path '.\.mvn\settings.xml' -ItemType "file" -Value "$xmlcontent"
                  cat .\.mvn\settings.xml
                  .\mvnw --settings .\.mvn\settings.xml -DfunctionAppName=question-service-$(Build.SourceBranchName) azure-functions:deploy -X
          - task: AzureCLI@2
            displayName: "Set Secret Mongo Uri on App"
            env:
                SPRING_DATA_MONGODB_URI: $(mongodbUri)
            inputs:
              addSpnToEnvironment: true
              failOnStandardError: true
              azureSubscription: question-service-hzprod-rg-access
              scriptType: ps
              scriptLocation: inlineScript
              inlineScript: |
                az functionapp config appsettings set --name question-service-$(functionAppName) --resource-group math-dojo-hzprod-question-service --settings `SPRING_DATA_MONGODB_URI=$env:SPRING_DATA_MONGODB_URI` | Out-Null
          - ${{ each item in parameters }}:
            - task: AzureCLI@2
              displayName: "Set app param: ${{ item.value }}"
              inputs:
                  addSpnToEnvironment: true
                  failOnStandardError: true
                  azureSubscription: question-service-hzprod-rg-access
                  scriptType: ps
                  scriptLocation: inlineScript
                  inlineScript: |
                    az functionapp config appsettings set --name question-service-$(functionAppName) --resource-group math-dojo-hzprod-question-service --settings "${{ item.value }}=$(${{ item.value }})" | Out-Null
  - stage: Run_Integration_Tests
    dependsOn:
    - Build
    variables:
      ${{ if eq(variables['Build.Reason'], 'PullRequest') }}: 
        functionAppName: "pr$(System.PullRequest.PullRequestNumber)"
      ${{ if not(eq(variables['Build.Reason'], 'PullRequest')) }}: 
        functionAppName: "$(Build.SourceBranchName)"
    condition: and(eq(variables['Build.Reason'], 'PullRequest'),succeeded('Configure_App'))
    jobs:
      - job: Exec_Integration_Tests
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: workingDir
              path: $(System.DefaultWorkingDirectory)
            displayName: Retrieve Stashed Artefacts
          - script: |
              cd ./integration-tests
              npm test -- --world-parameters {\"baseFunctionUri\":\"https://mathdojoio.cloud.tyk.io/question-service-np-test/api\",\"apiKey\":\"\",\"xApiVersion\":\"$(functionAppName)\"}
            displayName: Exec Npm Test
